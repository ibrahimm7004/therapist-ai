<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen 3</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px; /* Reduced space below the header */
            width: 100%;
            max-width: 600px; /* Match chatbox width */
        }

        .chat-title {
            background-color: #4a90e2; /* Primary theme color */
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.5rem;
            text-align: left;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            margin-top: 30px; /* Move the title downward */
        }

        .chat-gif-container {
            display: flex;
            justify-content: center; /* Center the GIF horizontally */
            align-items: center; /* Align vertically */
            width: 140px; /* Fixed width for the container */
            height: auto;
            margin-left: 10px; /* Adjust horizontal positioning */
            margin-top: 30px; /* Move the GIF downward */
        }

        .chat-gif {
            max-height: 140px; /* Adjusted GIF size */
            width: auto;
            border-radius: 10px;
        }

        .chat-message {
            margin-bottom: 15px; /* Space between messages */
            line-height: 1.6; /* Better line spacing */
        }

        .chat-user {
            margin-right: 8px; /* Space between "You:" or "AI:" and the message */
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-soft">
    <div class="container vh-100 d-flex flex-column justify-content-center align-items-center">
        <!-- Header Section -->
        <div class="chat-header">
            <!-- Title -->
            <div class="chat-title">
                Chat with our Therapy Bot!
            </div>

            <!-- GIF Container -->
            <div class="chat-gif-container">
                <img src="{{ url_for('static', filename='boba_icon.453c99ceb66532980dec.gif') }}" alt="Therapist GIF" class="chat-gif">
            </div>
        </div>

        <!-- Chat Widget -->
        <div class="card shadow p-4 mb-3" style="width: 100%; max-width: 600px; height: 400px; overflow-y: auto;">
            <div id="chat-history" class="mb-3" style="height: 300px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px;">
                <!-- Chat history will be dynamically updated -->
            </div>
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." />
                <button class="btn btn-primary" id="send-message">Send</button>
            </div>
        </div>

        <!-- End Session Button -->
        <button class="btn btn-danger btn-lg" id="endSessionBtn" style="position: absolute; bottom: 20px; right: 20px;">End Session</button>

        <video id="video" autoplay playsinline style="display: none;"></video>
        <canvas id="canvas" style="display: none;"></canvas>
    </div>

    <script>
        let endSession = false;

        document.getElementById("endSessionBtn").addEventListener("click", () => {
            endSession = true;
            console.log("End session clicked. Stopping...");

            // Redirect the user to screen 4
            window.location.href = "/screen4";
        });

        // Chat functionality
        document.getElementById("send-message").addEventListener("click", async () => {
            const input = document.getElementById("chat-input");
            const message = input.value.trim();

            if (message) {
                const chatHistory = document.getElementById("chat-history");

                // Add user's message to the chat history
                chatHistory.innerHTML += `<div class="chat-message"><span class="chat-user">You:</span> ${message}</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Clear the input field immediately after sending
                input.value = '';

                // Send message to server
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                if (data.response) {
                    // Add AI's response to the chat history
                    chatHistory.innerHTML += `<div class="chat-message"><span class="chat-user">AI:</span> ${data.response}</div>`;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
            }
        });

        // Allow pressing Enter to send the message
        document.getElementById("chat-input").addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault(); // Prevent default behavior
                document.getElementById("send-message").click(); // Trigger the send button click
            }
        });

        // Image capture logic (original code)
        async function captureAndSendImages() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                video.srcObject = stream;

                console.log("Camera access granted. Starting capture loop...");

                while (!endSession) {
                    await new Promise((resolve) => {
                        if (video.readyState >= 2) resolve();
                        else video.addEventListener('loadeddata', resolve, { once: true });
                    });

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    console.log("Image captured from video. Preparing to send...");

                    const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg'));

                    const formData = new FormData();
                    formData.append('image', blob, 'temp.jpg');

                    try {
                        const response = await fetch('/save_image', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            console.log("Image processed successfully.");
                        } else {
                            console.error("Error processing image:", await response.text());
                        }
                    } catch (error) {
                        console.error("Error sending image to server:", error);
                    }

                    await new Promise((resolve) => setTimeout(resolve, 1000));
                }

                stream.getTracks().forEach((track) => track.stop());
                console.log("Camera stream stopped. Session ended.");
            } catch (error) {
                console.error("Error in capture loop:", error);
            }
        }

        captureAndSendImages();
    </script>
</body>
</html>
